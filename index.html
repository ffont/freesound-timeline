<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
		<title>fressound timeline</title>
		<script type="text/javascript" src="freesound.js"></script>
		<script src="audioengine.js"></script>
	</head>
	<body>
		<script type="text/javascript">

			function randomBetween(min, max) {
				// from https://stackoverflow.com/questions/4959975/generate-random-number-between-two-numbers-in-javascript
			    if (min < 0) {
			        return min + Math.random() * (Math.abs(min)+max);
			    }else {
			        return min + Math.random() * max;
			    }
			}

			window.onload = function(){
				freesound.setToken("d31c795be3f70f7f04b21aeca4c5b48a599db6e9");

				// Set month, year and popularity measure from hash (if present)
				var hash = window.location.hash;
				hash = hash.slice(1,hash.length).split(',');

				var month = hash[0];
				var year = hash[1];
				var alternative = hash[2];
				
				if ((month !== undefined) && (year !== undefined)){
					document.getElementById('month').value = month;
					document.getElementById('year').value = year;
				}
				if (alternative == 'true') {
					document.getElementById("alternative").checked = true;
				}
			};

			function playSound(name,url){				

				document.getElementById("respSearch").innerHTML = "Playing: " + name;
				am.playSoundFromURL(url, 0, {
					panHRTF: {x:randomBetween(-1.0, 1.0), y:randomBetween(-2.0, 2.0), z:randomBetween(-2.0, 2.0) },
					onended: function(event){
						playSound(name, url);  // On end, play again the sound
						// NOTE: we don't use Web Audio API loop prop here as it does not trigger onended event
					}
				});
				
				if (document.getElementById("panic2").offsetParent !== null){
					document.getElementById("panic2").style.display = 'none';
					document.getElementById("panic1").style.display = 'block';
				}
			}
			
			function search(){

				stopAllSounds();

				var month = document.getElementById('month').value;
				var year = document.getElementById('year').value;

				var q = "";
				var p = 1;
				var f = "created:[" + year + "-" + month + "-1T00:00:00Z TO " + get_next_year(year,month) + "-" + get_next_month(month) + "-01T00:00:00Z] duration:[0.0 TO 60]";
				if (!document.getElementById('alternative').checked){
					var s = "rating_desc";
				}else{
					var s = "downloads_desc";
				}

				var hash = month + ',' + year + ',' + document.getElementById('alternative').checked;
				parent.location.hash = hash;
				
				var fields = "id,name,previews"
				freesound.textSearch(q, {page:p, filter:f, sort:s, fields:fields},
		            function(data){
		            	var sounds = data.results;
		            	console.log("Resuls received")
						if (sounds.length == 0){
							document.getElementById("respSearch").innerHTML = "";
							document.getElementById("respSearch").innerHTML = "No results...";
						}else{
							document.getElementById("respSearch").innerHTML = "";
							document.getElementById("respSearch").innerHTML = "Loading sounds... will begin playing at any moment...";
							for (i =0;i<sounds.length;i++){  
			                    var snd = sounds[i];
			                    playSound(snd.name, snd.previews['preview-hq-mp3'])	 // ogg seems to fail on safari...
			                }
						}
		                
		            },function(){ 
		            	document.getElementById("respSearch").innerHTML = "Error while searching..."; 
		            }
		        );
				console.log("Waiting for results...")
				document.getElementById("respSearch").innerHTML = "";
				document.getElementById("respSearch").innerHTML = "Waiting for results...";
			}
			
			function next(){
				var month = document.getElementById('month').value;
				var year = document.getElementById('year').value;
				document.getElementById('month').value = get_next_month(month)
				document.getElementById('year').value = get_next_year(year,month)
				search()
			}
			
			function previous(){
				var month = document.getElementById('month').value;
				var year = document.getElementById('year').value;
				document.getElementById('month').value = get_previous_month(month)
				document.getElementById('year').value = get_previous_year(year,month)
				search()
			}
			
			
			function get_next_month(month){
				if (parseInt(month,10) >= 12){
					return "1"
				}else{
					return (parseInt(month,10) + 1).toString()
				}
			}
			
			function get_next_year(year,month){
				if (parseInt(month,10) >= 12){
					return (parseInt(year,10) + 1).toString()
				}else{
					return year
				}
			}
			
			function get_previous_month(month){
				if (parseInt(month,10) <= 1){
					return "12"
				}else{
					return (parseInt(month,10) - 1).toString()
				}
			}
			
			function get_previous_year(year,month){
				if (parseInt(month,10) <= 1){
					return (parseInt(year,10) - 1).toString()
				}else{
					return year
				}
			}
			
			function stopAllSounds(){			
	  			am.stopAllBuffers(disableOnEnded=true);
				document.getElementById("panic1").style.display = 'none';
				document.getElementById("panic2").style.display = 'block';
				document.getElementById("respSearch").innerHTML = "";
			}
		</script>
		<br>
		<h1 id="header" style="font-family:Helvetica, Arial; text-align: center">free<span style="color:#F31C36">sound</span> timeline</h1>
		<div style="text-align:center;font-family:Helvetica, Arial;font-size:12px">
			enter month (1-12): <input type="text" id="month" value="8" size=2 maxlength=2>
			<br>
			enter year (2005-now): <input type="text" id="year" value="2011" size=4 maxlength=4>
			<br>
			<input type="button" id="search" value="go!" onclick="search()">
			<input type="checkbox" id="alternative">
			<br>
			<input type="button" id="search" value="<<" onclick="previous()"><input type="button" id="search" value=">>" onclick="next()">
			<br><br>
			<span id="respSearch"></span>
			<br>
			<br>
			<div id="panic1" style="display:none">
				<input type="button" id="stopAllSounds" value="panic!" onclick="stopAllSounds()">
			</div>
			<div id="panic2">
				no need for panic button... yet!
			</div>
			<br>
			<br>
			<div style="max-width:800px;display:inline-block;color:gray;">	
				This is a very simple and stupid hack that gets the most popular sounds in <a href="freesound.org" target="_blank">Freesound</a> for a given
				year and month and plays them all at once (in loop). Set the checkbox on for an alternative "measure" of popularity. This hack was originally implemented in 2011 when I was starting to learn about web technologies. It has been recently updated to use Freesound APIv2 and Web Audio API (with random HRTF panning for each sound!), but besides that the bad code has been left intact. Want to contribute? visit the <a href="http://github.com/ffont/freesound-timeline" target="_blank">code repository</a>.
			</div>
		</div>
	</body>
</html>